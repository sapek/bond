# fsharp feature branch
-
    version: 1.0.{build}
    clone_depth: 15
    branches:
        only:
            - fsharp
    configuration: Debug
    build:
        project: fsharp\fsharp.sln
        verbosity: minimal
    test:
        assemblies: fsharp\test\TypeProvider\bin\$(configuration)\BondFsharpUnitTest.dll

# other branches
-
    version: 1.0.{build}
    clone_depth: 15

    environment:
        matrix:
            - BOND_BUILD: C++
              BOND_CMAKE_GENERATOR: "Visual Studio 14 2015 Win64"
              BOND_MSC_VER: 14
              BOND_MSC_BITS: 64
              BOND_BOOST: 59
            - BOND_BUILD: C#
              BOND_OUTPUT: Properties
              BOND_CONFIG: Debug
            - BOND_BUILD: Doc
            - BOND_BUILD: C++
              BOND_CMAKE_GENERATOR: "Visual Studio 12 2013"
              BOND_MSC_VER: 12
              BOND_MSC_BITS: 32
              BOND_BOOST: 55
            - BOND_BUILD: C#
              BOND_OUTPUT: Fields
              BOND_CONFIG: Fields

    install:
        - ps: >-
            if ($env:BOND_BUILD -eq "C++") {

                git submodule update --init

                if (!(Test-Path boost.exe)) {

                    echo "Downloading Boost 1.${env:BOND_BOOST} ..."

                    Start-FileDownload "http://iweb.dl.sourceforge.net/project/boost/boost-binaries/1.${env:BOND_BOOST}.0/boost_1_${env:BOND_BOOST}_0-msvc-${env:BOND_MSC_VER}.0-${env:BOND_MSC_BITS}.exe" -FileName boost.exe -Timeout 1200000

                }

                echo "Extracting Boost..."

                .\boost.exe /DIR="${env:APPVEYOR_BUILD_FOLDER}\\boost_1_${env:BOND_BOOST}_0" /VERYSILENT

                $env:BOOST_ROOT = "${env:APPVEYOR_BUILD_FOLDER}/boost_1_${env:BOND_BOOST}_0"

                $env:BOOST_LIBRARYDIR = "${env:BOOST_ROOT}/lib${env:BOND_MSC_BITS}-msvc-${env:BOND_MSC_VER}.0"

            }

            choco install haskellplatform -version 2014.2.0.0 -y

            $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine")

            cabal update

            if ($env:BOND_BUILD -eq "Doc") {

                cabal install --verbose=0 pandoc

                choco install doxygen.install -y

            }

            $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine")

    cache:
        - cs\packages -> cs\test\core\packages.config
        - compiler\.cabal-sandbox -> compiler\bond.cabal
        - boost.exe

    before_build:
        - ps: >-
            if ($env:BOND_BUILD -eq "C#") {

                nuget restore cs\cs.sln

            }

            if ($env:BOND_BUILD -eq "C++") {

                mkdir build

                cd build

                Wait-Process -name boost

                dir "${env:BOOST_LIBRARYDIR}\\*.*"

                cmake "-DBoost_ADDITIONAL_VERSIONS=1.${env:BOND_BOOST}.0" -G $env:BOND_CMAKE_GENERATOR ..

            }

            if ($env:BOND_BUILD -eq "Doc") {

                mkdir build

                cd build

                cmake ../doc

            }

            $env:PreferredToolArchitecture = "x64"

    build_script:
        - ps: >-
            if ($env:BOND_BUILD -eq "Doc") {

                cmake --build . --target documentation -- /verbosity:minimal /logger:"C:\Program Files\AppVeyor\BuildAgent\Appveyor.MSBuildLogger.dll"

            }

            if ($env:BOND_BUILD -eq "C++") {

                cmake --build . --target check -- /verbosity:minimal /logger:"C:\Program Files\AppVeyor\BuildAgent\Appveyor.MSBuildLogger.dll"

            }

            if ($env:BOND_BUILD -eq "C#") {

                msbuild cs\cs.sln /verbosity:minimal /p:Configuration=${env:BOND_CONFIG} /logger:"C:\Program Files\AppVeyor\BuildAgent\Appveyor.MSBuildLogger.dll"

            }

            if (-not $?) { throw "build failed" }

    test_script:
        - ps: >-
            $ErrorActionPreference = "Stop"

            if ($env:BOND_BUILD -eq "C#") {

                nunit-console-x86 /framework:net-4.0 /labels "cs\test\core\bin\debug\net40\${env:BOND_OUTPUT}\Bond.UnitTest.dll" cs\test\internal\bin\debug\net40\Bond.InternalTest.dll

                nunit-console-x86 /framework:net-4.5 /labels "cs\test\core\bin\debug\net45\${env:BOND_OUTPUT}\Bond.UnitTest.dll" cs\test\internal\bin\debug\net45\Bond.InternalTest.dll

            }
